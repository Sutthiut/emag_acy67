from firebase_functions import https_fn
from firebase_admin import initialize_app, firestore
import numpy as np
import joblib
import random
import json  # <--- ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏à‡∏∞ Error ‡∏Ñ‡∏£‡∏±‡∏ö

# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
initialize_app()

# ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
try:
    model = joblib.load('my_posture_model.pkl')
except:
    model = None 

@https_fn.on_request()
def analyze_my_posture(req: https_fn.Request) -> https_fn.Response:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Mobile App ‡∏¢‡∏¥‡∏á Request ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    """
    # 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ User ID
    user_id = req.args.get('userId')
    
    if not user_id:
        return https_fn.Response("Error: Missing userId", status=400)

    # 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• History ‡∏à‡∏≤‡∏Å Firebase
    db = firestore.client()
    docs = db.collection('users').document(user_id).collection('history').order_by('timestamp', direction=firestore.Query.DESCENDING).limit(50).stream()
    
    history_data = []
    for doc in docs:
        history_data.append(doc.to_dict())
        
    if not history_data:
        return https_fn.Response("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏Å‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö", status=200)

    # 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (AI Logic)
    slouch_count = 0     # ‡∏Å‡πâ‡∏°‡∏´‡∏ô‡πâ‡∏≤
    lean_back_count = 0  # ‡πÄ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
    lean_side_count = 0  # ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á
    correct_count = 0
    total = 0

    for item in history_data:
        total += 1
        p = item.get('deltaPitch', 0)
        r = item.get('deltaRoll', 0)
        
        # Priority 1: ‡πÉ‡∏ä‡πâ Model ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
        if model:
            pred = model.predict([[p, r]])[0] 
            if pred == 1:
                correct_count += 1
                continue 
        
        # Priority 2: ‡πÉ‡∏ä‡πâ Rule-based ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏ô
        if p < -10:
            slouch_count += 1
        elif p > 10:
            lean_back_count += 1
        elif abs(r) > 3:
            lean_side_count += 1
        else:
            correct_count += 1 

    # 4. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    score = int((correct_count / total) * 100)
    
    # ‡∏´‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å
    problems = {
        "‡∏Å‡πâ‡∏°‡∏´‡∏ô‡πâ‡∏≤": slouch_count,
        "‡πÄ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á": lean_back_count,
        "‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏µ‡∏¢‡∏á": lean_side_count
    }
    main_issue = max(problems, key=problems.get) 
    
    # ---------------------------------------------------------
    # 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Generation Part - ‡∏â‡∏ö‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î) üí¨‚ú®
    # ---------------------------------------------------------
    advice_text = ""
    
    if score >= 80:
        # --- ‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏ä‡∏°‡πÄ‡∏ä‡∏¢ (Random) ---
        good_msgs = [
            f"üéâ ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô {score}% ‡∏ô‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö",
            f"üåü ‡∏ó‡πà‡∏≤‡∏™‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ({score}%) Keep Look ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö Office Syndrome ‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô",
            f"‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ({score}%) ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡πÅ‡∏•‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ô‡∏∞",
            f"üèÜ Pro Player ‡∏ä‡∏±‡∏î‡πÜ! ‡∏ô‡∏±‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ {score}% ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏ß‡πÜ ‡πÑ‡∏°‡πà‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏±‡∏ß‡∏£‡πå",
            f"üßò‚Äç‚ôÇÔ∏è ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ({score}%) ‡∏ô‡∏±‡πà‡∏á‡∏î‡∏µ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡πà‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!"
        ]
        advice_text = random.choice(good_msgs)

    elif score >= 50:
        # --- ‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏†‡∏≤‡∏û (Random) ---
        medium_msgs = [
            f"üëç ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ({score}%) ‡πÅ‡∏ï‡πà‡πÄ‡∏ú‡∏•‡∏≠ '{main_issue}' ‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏ô‡∏¥‡∏î ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö",
            f"ü§è ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏û‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß ({score}%) ‡∏ï‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ä‡∏≠‡∏ö '{main_issue}' ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ú‡∏•‡∏≠‡πÜ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏¥‡∏ö!",
            f"üßê ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡∏£‡∏±‡∏ö ({score}%) ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° '{main_issue}' ‡∏ö‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏±‡∏Å‡∏¢‡∏∑‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°?",
            f"üîß ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô {score}% ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏•‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ '{main_issue}' ‡∏•‡∏á‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ã‡∏ü‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢",
            f"ü§î ‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏∏‡∏î‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ô‡∏∞ ({score}%) ‡∏≠‡∏¢‡πà‡∏≤ '{main_issue}' ‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏¥‡∏™‡∏±‡∏¢"
        ]
        advice_text = random.choice(medium_msgs)

    else:
        # --- ‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á: ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢/‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (Random) ---
        bad_msgs = [
            f"üö® ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {score}% ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì '{main_issue}' ‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏õ‡∏ß‡∏î‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö",
            f"üõë ‡∏û‡∏±‡∏Å‡∏î‡πà‡∏ß‡∏ô! ‡∏Ñ‡∏∏‡∏ì '{main_issue}' ‡∏à‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ({score}%) ‡∏•‡∏∏‡∏Å‡πÑ‡∏õ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏ñ‡∏≠‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö",
            f"üìâ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á ({score}%) ‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡πà‡∏á '{main_issue}' ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?",
            f"ü¶¥ ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß! ({score}%) ‡∏´‡∏¢‡∏∏‡∏î '{main_issue}' ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö AI ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡∏ô‡∏∞",
            f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ({score}%) ‡∏Ñ‡∏∏‡∏ì '{main_issue}' ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏´‡∏°‡∏≠‡∏ô‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏ô‡∏∞ ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô!"
        ]
        advice_text = random.choice(bad_msgs)

    # 6. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ (JSON)
    response_data = {
        "score": score,
        "advice": advice_text,
        "main_issue": main_issue
    }
    
    return https_fn.Response(json.dumps(response_data), content_type="application/json")
